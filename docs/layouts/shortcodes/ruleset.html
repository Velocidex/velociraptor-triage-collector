
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js">
</script>

<div class="input-group">
  <span class="input-group-addon"
        id="clear"><i class="fas fa-xmark"></i>
  </span>
  <input type="text" id="myInput" onkeyup="doSearch()"
         class="form-control"
         placeholder="Search targets"
         aria-describedby="basic-addon2">
  <span class="input-group-addon"
        id="basic-addon2"><i class="fas fa-search"></i>
    <span class="total-count"></span>
  </span>
</div>

<hr />

<div class="search_results"></div>

<script>
  $("#clear").click(function() {
      let next = $(this).next("input");
      if (next) { next.val(""); doSearch(); }
  })

let all_data = [];
let data_lookup = {};

function trimHash(input) {
  if(input.startsWith("#")) {
      return input.slice(1)
  };
  return input;
}

$.ajax({
    url: {{ .Get 0 }},
}).done(function( data ) {
    all_data = [];
    data_lookup = data;
    for (const [key, value] of Object.entries(data)) {
        all_data.push(value);
    }

  let input = document.getElementById('myInput');
  if(input) {
      input.value = trimHash(decodeURI(window.location.hash));
      doSearch();
      return;
  };

    DrawResults(all_data);
});

function matchItem(filter, item) {
    let description = item.Description || "";
    let title = item.Name || "";

    if (title.toUpperCase().includes(filter) ||
        description.toUpperCase().includes(filter)) {
        return true;
    }

    let labels = [];
    if (item.Category) {
        labels.push(item.Category);
    }
    for(let j=0;j<labels.length;j++) {
        if (labels[j].toUpperCase().includes(filter)) {
            return true;
        }
    }
    return false;
}

const linebreak = new RegExp("[\\n\\r]")

function addRow(key, value, indent) {
    if(!indent) {
        indent = "";
    }

    if (linebreak.test(value)) {
        let lines = value.split("\n")
        for (let i=0;i<lines.length;i++) {
            lines[i] = indent + "  " + lines[i]
        }
        return "\n" + indent + key + ": |\n" + indent + lines.join("\n")
    };
    return "\n" + indent + key + ": " + value;
}

function buildDescript(item, all_data, indent) {
    let next_indent = indent + " ";

    let data = "";

    if (item.Name) {
        data += indent + addRow("Name", item.Name, indent);
    }

    if(item.Description) {
        data += indent + addRow("Description", item.Description, indent);
    }

    if (item.Author) {
        data += indent + addRow("Author", item.Author, indent)
    }

    if (item.Preamble) {
        data += indent + addRow("Preamble", item.Preamble, indent)
    }

    data += indent + addRow("Rules", "", indent);

    for(let i=0; i<item.Rules.length; i++) {
        let t = item.Rules[i];
        if (t.Name) {
            data += indent + addRow("Name", t.Name, next_indent);
        }
        if(t.Comment) {
            data += indent + addRow("Comment", t.Comment, next_indent);
        }
        if(t.Category) {
            data += indent + addRow("Category", t.Category, next_indent);
        }

        if(t.Glob) {
            data += indent + addRow("Glob", t.Glob, next_indent);
        }

        if(t.Ref) {
            data += indent + addRow("Reference", t.Ref, next_indent);
        }

        if(t.VQL) {
            data += indent + addRow("VQL", t.VQL, next_indent);
        }

        data += "\n" + indent
    }

    return data;
}

function buildGlobs(item, all_data) {
    let res = "";

    for(let i=0; i<item.Rules.length; i++) {
        let t = item.Rules[i];
        if(t.Glob) {
            res += addRow(item.Name + "/" + t.Name, t.Glob)
        }

        if(t.VQL) {
            res += addRow(item.Name + "/" + t.Name, t.VQL)
        }

        if(t.Ref) {
            let target = data_lookup[t.Ref];
            if(target) {
                res += buildGlobs(target, all_data)
            }
        }
    };

    return res
}

function insertRule(node, item, all_data, indent) {
    if(!indent) {
        indent = "";
    }

    let description = $(node).find("p.description");
    if (!description.length) {
        return;
    }

    let existing = node.find("pre");
    if (existing.length > 0) {
        existing.remove();
        description.show();
        return;
    }

    description.hide();

    let data = buildDescript(item, all_data, "");
    let highlighted = hljs.highlight(data, {language: "yaml"});
    let new_node = $("<pre>").append($("<code>").append(highlighted.value));
    description.after(new_node);

    return false;
}

function insertSummary(node, item, all_data, indent) {
    if(!indent) {
        indent = "";
    }

    let description = $(node).find("p.description");
    if (!description.length) {
        return;
    }

    let existing = node.find("pre");
    if (existing.length > 0) {
        existing.remove();
        description.show();
        return;
    }

    description.hide();

    let data = buildGlobs(item, all_data);
    let highlighted = hljs.highlight(data, {language: "yaml"});
    let new_node = $("<pre>").append($("<code>").append(highlighted.value));
    description.after(new_node);

    return false;
}

function doSearch() {
  // Declare variables
  let input = document.getElementById('myInput');
  let filter = input.value.toUpperCase();

  window.location.hash = encodeURI(input.value);

  let result = [];
  for(let i=0;i<all_data.length; i++) {
      let item = all_data[i];
      if (matchItem(filter, item)) {
          result.push(item);
      };
      if (result.length > 500) {
          break;
      }
  };
  DrawResults(result);
}

// Only show up to 50 hits to make the page load faster.
function DrawResults(data) {
    $(".search_results").empty();
    $("span.total-count").text("Total " + data.length);

    data = data.sort(function(a,b) {
        return a.Name < b.Name ? -1 : 1;
    });

    let most_results = data.length;
    if(most_results > 500) {
        most_results = 500;
    }

  for(let i=0;i<most_results; i++) {
      let item = data[i];
      let template = $(`
<div class="panel panel-default color">
  <div class="panel-heading color">
    <h3 class="panel-title color " >
      <a class="new-tab" href="#" title="NewPage" target="_blank">
        <i class="fa-solid fa-arrow-up-right-from-square"></i>
      </a>
      <a class="summary" href="" title="Expand Globs">
        <i class="fa-solid fa-list-check"></i>
      </a>
      <a class="title" href="" title="View Definition"></a>
      <div class="author pull-right"></div>
    </h3>
  </div>
  <div class="panel-body color">
    <div class="border color">
       <div class="border color">
         <div class="idea-inner-text-main color">
           <p class="description "></p>
           <p class="idea-tag space"></p>
         </div>
       </div>
    </div>
</div>`);

      template.find(".title").append(item.Name);
      let link = new URL(window.location.href);
      link.hash = encodeURI(item.Name);
      template.find("a.new-tab").attr("href", link);


      template.find(".author").append(item.Author);
      template.find(".description").append(item.Description);
      template.find(".title").attr("href", item.link).click(function() {
          insertRule(template, item, data, "");
          return false;
      });
      template.find(".summary").attr("href", item.link).click(function() {
          insertSummary(template, item, data, "");
          return false;
      });

    let labels = {};
    for(let i=0;i<item.Rules.length; i++) {
        let rule = item.Rules[0];
        if (rule.Category) {
            labels[rule.Category] = true;
        }
    };
    for (const [tag, value] of Object.entries(labels)) {
        let link = $(`
<a class="space tag"><i class="linkcolour label label-success">` +
                     tag + `</i></a>`).click(function() {
                         document.getElementById('myInput').value = tag;
                         doSearch();
                     });
        template.find(".idea-tag").append(link);
    }
    let new_item = $(".search_results").append(template);
  }
};

$(function() {
  $(document).tooltip();
});

</script>
